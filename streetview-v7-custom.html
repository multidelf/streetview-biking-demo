
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸€é¨å‡ºç™¼å§ï½œè¡—æ™¯æ¨¡æ“¬å™¨ V7.3.1</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
    #logoHeader {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.85); padding: 5px 10px;
      display: flex; align-items: center; font-weight: bold; border-radius: 6px;
    }
    #controlPanel {
      position: absolute; top: 60px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding: 12px; width: 400px;
      border-left: 5px solid #4CAF50; border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px;
    }
    select, textarea, input[type="text"], button {
      width: 100%; margin-top: 6px; padding: 6px;
      font-size: 14px; border: 1px solid #ccc; border-radius: 4px;
    }
    .small-btn {
      width: auto; padding: 4px 8px; font-size: 13px;
      background: #4CAF50; color: white; border: none; border-radius: 4px;
      cursor: pointer; margin-left: 10px;
      display: none;
    }
    .mode-block { display: none; margin-top: 10px; }
    .checkbox-row { display: flex; align-items: center; margin-bottom: 4px; }
    .checkbox-row input[type="checkbox"] { margin-right: 8px; }
    #map, #pano { width: 100vw; height: 100vh; display: none; }
    #miniMap {
      position: absolute; bottom: 10px; right: 10px; z-index: 12;
      width: 200px; height: 200px; border: 2px solid #888;
      display: none;
    }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3MsVlR7h6MsYf1Xjw02BPwB3r95wXsYk&libraries=places"></script>
</head>
<body>
  <div id="logoHeader">ğŸš´ ä¸€é¨å‡ºç™¼å§ï½œè¡—æ™¯æ¨¡æ“¬å™¨ V7.3.1</div>
  <div id="controlPanel">
    <label for="modeSelect">
      ğŸ“Œ é¸æ“‡è¼¸å…¥æ¨¡å¼
      <button id="toggleViewBtn" class="small-btn" onclick="toggleView()">åˆ‡æ›è¡—æ™¯/è·¯ç·šè¦åŠƒ</button>
    </label>
    <select id="modeSelect">
      <option value="sheet">ğŸ”½ è·¯ç·šä¸‹æ‹‰é¸å–®</option>
      <option value="paste">ğŸ“ è²¼ä¸Šç¶“ç·¯åº¦</option>
      <option value="ab">ğŸ“ A â†’ B æœå°‹</option>
    </select>

    <div class="mode-block" id="sheetBlock">
      <select id="routeSelect"><option>è«‹é¸æ“‡è·¯ç·š</option></select>
      <div style="display:flex; gap:10px; margin-top:6px;">
        <button onclick="selectAll()">å…¨é¸</button>
        <button onclick="clearAll()">å–æ¶ˆå…¨é¸</button>
      </div>
      <div id="pointList" style="margin-top:10px; max-height:220px; overflow:auto;"></div>
      <button id="planPolylineBtn" style="margin-top:10px;">âœï¸ è¦åŠƒè·¯ç·š</button>
    </div>

    <div class="mode-block" id="pasteBlock">
      <textarea id="coordTextarea" rows="4" placeholder="è²¼ä¸Šç¶“ç·¯åº¦ï¼Œå¦‚ï¼š24.1612666,120.6951848"></textarea>
      <button onclick="drawFromPasted()">â• ç¹ªè£½æ¨™è¨˜</button>
    </div>

    <div class="mode-block" id="abBlock">
      <input id="pointA" placeholder="èµ·é»åœ°åæˆ–åœ°å€" />
      <input id="pointB" placeholder="çµ‚é»åœ°åæˆ–åœ°å€" />
      <button id="searchBtn" onclick="drawFromAB()">ğŸ§­ æœå°‹è·¯ç·šæ¨™è¨˜</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="pano"></div>
  <div id="miniMap"></div>

  <script>
    const apiBase = "https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec";
    let map, panorama, miniMap, miniMapMarker, infoWindow;
    let polyline, polylinePath = [], stepIndex = 0;
    let markers = [], markerA, markerB;
    let currentMode = 'map';

    function initMap() {
      const startPos = { lat: 24.15, lng: 120.68 };
      map = new google.maps.Map(document.getElementById("map"), { center: startPos, zoom: 13 });
      panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), {
        position: startPos, pov: { heading: 0, pitch: 0 }, visible: false
      });
      miniMap = new google.maps.Map(document.getElementById("miniMap"), {
        center: startPos, zoom: 16, disableDefaultUI: true
      });
      miniMapMarker = new google.maps.Marker({ map: miniMap, position: startPos });
      map.setStreetView(panorama);
      infoWindow = new google.maps.InfoWindow();

      fetchRouteNames();
      setupAutocomplete();
      document.getElementById("map").style.display = "block";
      document.getElementById("sheetBlock").style.display = "block";
      document.getElementById("modeSelect").addEventListener("change", e => {
        document.querySelectorAll('.mode-block').forEach(el => el.style.display = 'none');
        document.getElementById(e.target.value + "Block").style.display = "block";
      });
      document.getElementById("planPolylineBtn").addEventListener("click", planPolyline);
      window.addEventListener("keydown", handleKey);
    }

    function setupAutocomplete() {
      const inputA = document.getElementById("pointA");
      const inputB = document.getElementById("pointB");
      const autoA = new google.maps.places.Autocomplete(inputA);
      const autoB = new google.maps.places.Autocomplete(inputB);
      autoA.addListener("place_changed", () => {
        const place = autoA.getPlace();
        if (!place.geometry) return;
        if (markerA) markerA.setMap(null);
        markerA = new google.maps.Marker({ map, position: place.geometry.location });
        map.setCenter(place.geometry.location);
        toggleSearchBtn();
      });
      autoB.addListener("place_changed", () => {
        const place = autoB.getPlace();
        if (!place.geometry) return;
        if (markerB) markerB.setMap(null);
        markerB = new google.maps.Marker({ map, position: place.geometry.location });
        map.setCenter(place.geometry.location);
        toggleSearchBtn();
      });
    }

    function toggleSearchBtn() {
      const a = document.getElementById("pointA").value.trim();
      const b = document.getElementById("pointB").value.trim();
      document.getElementById("searchBtn").disabled = !(a && b);
    }

    function drawFromPasted() {
      clearMapObjects();
      const raw = document.getElementById("coordTextarea").value.trim();
      const lines = raw.split("\n");
      const path = [];
      lines.forEach((line, i) => {
        const match = line.match(/([\d\.\-]+)[^\d\.\-]+([\d\.\-]+)/);
        if (match) {
          const lat = parseFloat(match[1]), lng = parseFloat(match[2]);
          const marker = new google.maps.Marker({ map, position: { lat, lng } });
          markers.push(marker);
          path.push({ lat, lng });
        }
      });
      drawPolylinePath(path);
      if (path.length) map.setCenter(path[0]);
    }

    function drawFromAB() {
      clearMapObjects();
      const service = new google.maps.DirectionsService();
      service.route({
        origin: document.getElementById("pointA").value,
        destination: document.getElementById("pointB").value,
        travelMode: "BICYCLING"
      }, (res, status) => {
        if (status === "OK") {
          const path = res.routes[0].overview_path;
          drawPolylinePath(path);
          map.setCenter(path[0]);
          panorama.setPosition(path[0]);
          miniMap.setCenter(path[0]);
          miniMapMarker.setPosition(path[0]);
          stepIndex = 0;
        } else {
          alert("æœå°‹å¤±æ•—ï¼š" + status);
        }
      });
    }

    function drawPolylinePath(path) {
      if (polyline) polyline.setMap(null);
      polylinePath = path;
      polyline = new google.maps.Polyline({ path, map, strokeColor: "#FF5722", strokeWeight: 4 });
    }

    function handleKey(e) {
      if (currentMode !== 'street' || polylinePath.length < 2) return;
      if (e.key === 'w') stepIndex = Math.min(polylinePath.length - 1, stepIndex + 1);
      if (e.key === 's') stepIndex = Math.max(0, stepIndex - 1);
      if (e.key === 'a') panorama.setPov({ ...panorama.getPov(), heading: panorama.getPov().heading - 15 });
      if (e.key === 'd') panorama.setPov({ ...panorama.getPov(), heading: panorama.getPov().heading + 15 });
      const pos = polylinePath[stepIndex];
      panorama.setPosition(pos);
      miniMap.setCenter(pos);
      miniMapMarker.setPosition(pos);
    }

    function toggleView() {
      if (currentMode === 'map') {
        document.getElementById("map").style.display = "none";
        document.getElementById("pano").style.display = "block";
        document.getElementById("miniMap").style.display = "block";
        panorama.setVisible(true);
        currentMode = 'street';
      } else {
        document.getElementById("pano").style.display = "none";
        document.getElementById("map").style.display = "block";
        document.getElementById("miniMap").style.display = "none";
        panorama.setVisible(false);
        currentMode = 'map';
      }
    }

    function fetchRouteNames() {
      fetch(apiBase).then(r => r.json()).then(data => {
        const sel = document.getElementById("routeSelect");
        sel.innerHTML = `<option>è«‹é¸æ“‡è·¯ç·š</option>` + data.routes.map(name => `<option value="${name}">${name}</option>`).join("");
        sel.addEventListener("change", () => fetchRouteByName(sel.value));
      });
    }

    function fetchRouteByName(name) {
      clearMapObjects();
      fetch(`${apiBase}?routeName=${encodeURIComponent(name)}`)
        .then(r => r.json()).then(data => {
          const list = document.getElementById("pointList");
          list.innerHTML = "";
          data.points.forEach((p, i) => {
            const row = document.createElement("div");
            row.className = "checkbox-row";
            row.innerHTML = `<input type="checkbox" data-lat="${p.lat}" data-lng="${p.lng}"><label>ç¬¬${p.order}ç«™ ${p.name}</label>`;
            const cb = row.querySelector("input");
            cb.addEventListener("change", () => {
              if (cb.checked) {
                const marker = new google.maps.Marker({ map, position: { lat: p.lat, lng: p.lng } });
                markers[i] = marker;
              } else if (markers[i]) markers[i].setMap(null);
            });
            list.appendChild(row);
          });
        });
    }

    function planPolyline() {
      const path = [];
      document.querySelectorAll("#pointList input[type=checkbox]").forEach((cb, i) => {
        if (cb.checked && markers[i]) path.push(markers[i].getPosition().toJSON());
      });
      if (path.length < 2) return alert("è«‹è‡³å°‘é¸æ“‡å…©å€‹ç«™é»");
      const service = new google.maps.DirectionsService();
      service.route({
        origin: path[0],
        destination: path[path.length - 1],
        waypoints: path.slice(1, -1).map(p => ({ location: p })),
        travelMode: "BICYCLING"
      }, (res, status) => {
        if (status === "OK") {
          drawPolylinePath(res.routes[0].overview_path);
          map.setCenter(res.routes[0].overview_path[0]);
          panorama.setPosition(res.routes[0].overview_path[0]);
          miniMap.setCenter(res.routes[0].overview_path[0]);
          miniMapMarker.setPosition(res.routes[0].overview_path[0]);
          stepIndex = 0;
          document.getElementById("toggleViewBtn").style.display = "inline-block";
        } else {
          alert("è·¯ç·šç¹ªè£½å¤±æ•—ï¼š" + status);
        }
      });
    }

    function clearMapObjects() {
      markers.forEach(m => m?.setMap(null));
      markers = [];
      if (polyline) polyline.setMap(null);
    }

    window.onload = initMap;
  </script>
</body>
</html>
