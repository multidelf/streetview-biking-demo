
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸€é¨å‡ºç™¼å§ï½œè¡—æ™¯æ¨¡æ“¬å™¨ V8</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #logoHeader {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.85); padding: 5px 10px;
      display: flex; align-items: center; font-weight: bold; border-radius: 6px;
    }
    #logoHeader img { height: 32px; margin-right: 8px; }

    #controlPanel {
      position: absolute; top: 60px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding: 12px; width: 360px;
      border-left: 5px solid #4CAF50; border-radius: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 14px;
    }
    select, textarea, input, button {
      width: 100%; margin-top: 6px; padding: 6px;
      font-size: 14px; border: 1px solid #ccc; border-radius: 4px;
    }
    .mode-block { display: none; margin-top: 10px; }
    .stationList { margin-top: 8px; max-height: 180px; overflow-y: auto; }
    .stationItem { margin-bottom: 4px; }
    .marker-control { margin-top: 6px; display: flex; gap: 6px; }
    #map { width: 100%; height: 100%; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3MsVlR7h6MsYf1Xjw02BPwB3r95wXsYk&libraries=places"></script>
</head>
<body>
  <div id="logoHeader">
    <img src="assets/img/logo.jpg" alt="Logo">
    ä¸€é¨å‡ºç™¼å§ï½œè¡—æ™¯æ¨¡æ“¬å™¨ V8
  </div>

  <div id="controlPanel">
    <label for="modeSelect">ğŸ“Œ é¸æ“‡è¼¸å…¥æ¨¡å¼</label>
    <select id="modeSelect">
      <option value="sheet">ğŸ”½ è·¯ç·šä¸‹æ‹‰é¸å–®</option>
      <option value="paste">ğŸ“ è²¼ä¸Šç¶“ç·¯åº¦</option>
      <option value="ab">ğŸ“ A â†’ B æœå°‹</option>
    </select>

    <div class="mode-block" id="sheetBlock">
      <select id="routeSelect">
        <option value="">è«‹é¸æ“‡</option>
      </select>
      <div class="marker-control">
        <button onclick="selectAll(true)">å…¨é¸</button>
        <button onclick="selectAll(false)">å–æ¶ˆå…¨é¸</button>
      </div>
      <div class="stationList" id="sheetStations"></div>
    </div>

    <div class="mode-block" id="pasteBlock">
      <textarea id="coordTextarea" rows="4" placeholder="è²¼ä¸Šç¶“ç·¯åº¦ï¼Œå¦‚ï¼š
24.1612666,120.6951848
24.135119,120.683746"></textarea>
      <button onclick="parsePastedCoords()">è§£æè·¯ç·š</button>
      <div class="marker-control">
        <button onclick="selectAll(true, 'paste')">å…¨é¸</button>
        <button onclick="selectAll(false, 'paste')">å–æ¶ˆå…¨é¸</button>
      </div>
      <div class="stationList" id="pasteStations"></div>
    </div>

    <div class="mode-block" id="abBlock">
      <input id="pointA" placeholder="èµ·é»åœ°å€" />
      <input id="pointB" placeholder="çµ‚é»åœ°å€" />
      <button onclick="drawFromAB()">ğŸ§­ æŸ¥è©¢è·¯ç·š</button>
    </div>
  </div>

  <div id="map"></div>

  <script>
    const apiBase = "https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec";
    let map, infoWindow, markers = [];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 24.15, lng: 120.68 },
        zoom: 13
      });
      infoWindow = new google.maps.InfoWindow();
      new google.maps.places.Autocomplete(document.getElementById("pointA"));
      new google.maps.places.Autocomplete(document.getElementById("pointB"));
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function addMarker(lat, lng, label) {
      const m = new google.maps.Marker({ position: { lat, lng }, map });
      m.addListener("click", () => {
        infoWindow.setContent(label);
        infoWindow.open(map, m);
      });
      markers.push(m);
    }

    function changeMode() {
      document.querySelectorAll('.mode-block').forEach(el => el.style.display = 'none');
      const mode = document.getElementById("modeSelect").value;
      document.getElementById(mode + "Block").style.display = "block";
    }

    async function fetchRouteNames() {
      const res = await fetch(apiBase);
      const data = await res.json();
      const sel = document.getElementById("routeSelect");
      data.routes.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
      });
    }

    async function fetchRouteByName(name) {
      const res = await fetch(`${apiBase}?routeName=${encodeURIComponent(name)}`);
      const data = await res.json();
      const list = document.getElementById("sheetStations");
      list.innerHTML = "";
      clearMarkers();
      data.points.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "stationItem";
        const id = `sheet_${i}`;
        div.innerHTML = `<label><input type="checkbox" id="${id}" onchange="toggleMarker(this, ${p.lat}, ${p.lng}, '[#${p.order}] ${p.name}')"> [#${p.order}] ${p.name} (${p.lat.toFixed(5)}, ${p.lng.toFixed(5)})</label>`;
        list.appendChild(div);
      });
    }

    function parsePastedCoords() {
      const text = document.getElementById("coordTextarea").value.trim();
      const lines = text.split("\n").filter(Boolean);
      const list = document.getElementById("pasteStations");
      list.innerHTML = "";
      clearMarkers();
      lines.forEach((line, i) => {
        const parts = line.match(/([\d\.\-]+)[^\d\.\-]+([\d\.\-]+)/);
        if (!parts) return;
        const lat = parseFloat(parts[1]), lng = parseFloat(parts[2]);
        const label = `æ‰‹å‹•é» #${i + 1}`;
        const id = `paste_${i}`;
        const div = document.createElement("div");
        div.className = "stationItem";
        div.innerHTML = `<label><input type="checkbox" id="${id}" onchange="toggleMarker(this, ${lat}, ${lng}, '${label}')"> ${label} (${lat.toFixed(5)}, ${lng.toFixed(5)})</label>`;
        list.appendChild(div);
      });
    }

    function toggleMarker(checkbox, lat, lng, label) {
      if (checkbox.checked) {
        addMarker(lat, lng, label);
      } else {
        const found = markers.find(m => m.getPosition().lat() === lat && m.getPosition().lng() === lng);
        if (found) {
          found.setMap(null);
          markers = markers.filter(m => m !== found);
        }
      }
    }

    function selectAll(checked, mode = "sheet") {
      const container = document.getElementById(mode + "Stations");
      container.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.checked = checked;
        cb.dispatchEvent(new Event("change"));
      });
    }

    function drawFromAB() {
      const service = new google.maps.DirectionsService();
      service.route({
        origin: document.getElementById("pointA").value,
        destination: document.getElementById("pointB").value,
        travelMode: "BICYCLING"
      }, (res, status) => {
        if (status === "OK") {
          clearMarkers();
          const path = res.routes[0].overview_path;
          path.forEach((pt, i) => addMarker(pt.lat(), pt.lng(), `è·¯ç·šé» #${i + 1}`));
          if (path.length) map.setCenter(path[0]);
        } else {
          alert("ç„¡æ³•æŸ¥è©¢è·¯ç·šï¼š" + status);
        }
      });
    }

    window.onload = () => {
      initMap();
      changeMode();
      fetchRouteNames();
      document.getElementById("modeSelect").addEventListener("change", changeMode);
      document.getElementById("routeSelect").addEventListener("change", e => {
        if (e.target.value) fetchRouteByName(e.target.value);
      });
    };
  </script>
</body>
</html>
