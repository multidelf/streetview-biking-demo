
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ä¸€é¨å‡ºç™¼å§ï½œè¡—æ™¯æ¨¡æ“¬å™¨ V8</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 300px;
    }
    #stationList { max-height: 300px; overflow-y: auto; margin-top: 10px; }
    textarea, select, input { width: 100%; margin-top: 5px; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
</head>
<body>
<div id="panel">
  <label>ğŸ“Œ é¸æ“‡è¼¸å…¥æ¨¡å¼</label>
  <select id="modeSelect">
    <option value="route">ğŸ”½ è·¯ç·šä¸‹æ‹‰é¸å–®</option>
    <option value="coords">ğŸ“ è²¼ä¸Šç¶“ç·¯åº¦</option>
    <option value="ab">ğŸ“ A â†’ B æœå°‹</option>
  </select>

  <div id="inputRoute" class="mode">
    <select id="routeSelect"><option>è«‹é¸æ“‡è·¯ç·š</option></select>
    <button onclick="selectAll(true)">å…¨é¸</button>
    <button onclick="selectAll(false)">å–æ¶ˆå…¨é¸</button>
    <div id="stationList"></div>
  </div>

  <div id="inputCoords" class="mode" style="display:none">
    <textarea id="coordsBox" placeholder="24.1,120.6
24.2,120.7"></textarea>
    <button onclick="loadCoords()">è¼‰å…¥åº§æ¨™</button>
  </div>

  <div id="inputAB" class="mode" style="display:none">
    <input id="start" placeholder="èµ·é»åœ°å€æˆ–åœ°é»" />
    <input id="end" placeholder="çµ‚é»åœ°å€æˆ–åœ°é»" />
    <button onclick="findRoute()">æœå°‹è·¯ç·šæ¨™è¨˜</button>
  </div>
</div>
<div id="map"></div>
<script>
const apiBase = "https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec";
let map, markers = [];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 24.15, lng: 120.65 },
    zoom: 13
  });

  // æ¨¡å¼åˆ‡æ›
  document.getElementById("modeSelect").addEventListener("change", e => {
    document.querySelectorAll(".mode").forEach(div => div.style.display = "none");
    document.getElementById("input" + e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1)).style.display = "block";
  });

  // è¼‰å…¥ä¸‹æ‹‰é¸å–®
  fetch(apiBase).then(res => res.json()).then(data => {
    const select = document.getElementById("routeSelect");
    data.routes.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  });

  document.getElementById("routeSelect").addEventListener("change", () => {
    const name = document.getElementById("routeSelect").value;
    fetch(apiBase + "?routeName=" + encodeURIComponent(name)).then(res => res.json()).then(data => {
      clearMarkers();
      const list = document.getElementById("stationList");
      list.innerHTML = "";
      data.points.forEach((pt, i) => {
        const id = "chk" + i;
        const row = document.createElement("div");
        row.innerHTML = `<input type="checkbox" id="${id}" data-lat="${pt.lat}" data-lng="${pt.lng}" data-name="${pt.name}" onchange="toggleMarker(this)">
                         [#${pt.order}] ${pt.name || 'ï¼ˆæœªå‘½åï¼‰'} (${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)})`;
        list.appendChild(row);
      });
    });
  });
}

function selectAll(val) {
  document.querySelectorAll("#stationList input[type=checkbox]").forEach(cb => {
    cb.checked = val;
    cb.dispatchEvent(new Event("change"));
  });
}

function toggleMarker(cb) {
  const lat = parseFloat(cb.dataset.lat);
  const lng = parseFloat(cb.dataset.lng);
  const name = cb.dataset.name;
  if (cb.checked) {
    const m = new google.maps.Marker({ position: { lat, lng }, map });
    const info = new google.maps.InfoWindow({ content: name });
    m.addListener("click", () => info.open(map, m));
    cb._marker = m;
  } else if (cb._marker) {
    cb._marker.setMap(null);
  }
}

function clearMarkers() {
  document.querySelectorAll("#stationList input[type=checkbox]").forEach(cb => {
    if (cb._marker) cb._marker.setMap(null);
  });
}

function loadCoords() {
  clearMarkers();
  const lines = document.getElementById("coordsBox").value.trim().split("
");
  lines.forEach((line, i) => {
    const [lat, lng] = line.split(",").map(parseFloat);
    const m = new google.maps.Marker({ position: { lat, lng }, map });
    const info = new google.maps.InfoWindow({ content: "æ‰‹å‹•é» #" + (i + 1) });
    m.addListener("click", () => info.open(map, m));
  });
}

function findRoute() {
  const dir = new google.maps.DirectionsService();
  const renderer = new google.maps.DirectionsRenderer({ map });
  dir.route({
    origin: document.getElementById("start").value,
    destination: document.getElementById("end").value,
    travelMode: google.maps.TravelMode.BICYCLING
  }, (res, status) => {
    if (status === "OK") renderer.setDirections(res);
    else alert("æœå°‹å¤±æ•—ï¼š" + status);
  });
}

window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=places"></script>
</body>
</html>
