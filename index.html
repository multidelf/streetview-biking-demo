
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>一騎出發吧｜街景模擬器 V8</title>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 300px;
    }
    #stationList { max-height: 300px; overflow-y: auto; margin-top: 10px; }
    textarea, select, input { width: 100%; margin-top: 5px; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
</head>
<body>
<div id="panel">
  <label>📌 選擇輸入模式</label>
  <select id="modeSelect">
    <option value="route">🔽 路線下拉選單</option>
    <option value="coords">📝 貼上經緯度</option>
    <option value="ab">📍 A → B 搜尋</option>
  </select>

  <div id="inputRoute" class="mode">
    <select id="routeSelect"><option>請選擇路線</option></select>
    <button onclick="selectAll(true)">全選</button>
    <button onclick="selectAll(false)">取消全選</button>
    <div id="stationList"></div>
  </div>

  <div id="inputCoords" class="mode" style="display:none">
    <textarea id="coordsBox" placeholder="24.1,120.6
24.2,120.7"></textarea>
    <button onclick="loadCoords()">載入座標</button>
  </div>

  <div id="inputAB" class="mode" style="display:none">
    <input id="start" placeholder="起點地址或地點" />
    <input id="end" placeholder="終點地址或地點" />
    <button onclick="findRoute()">搜尋路線標記</button>
  </div>
</div>
<div id="map"></div>
<script>
const apiBase = "https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec";
let map, markers = [];

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 24.15, lng: 120.65 },
    zoom: 13
  });

  // 模式切換
  document.getElementById("modeSelect").addEventListener("change", e => {
    document.querySelectorAll(".mode").forEach(div => div.style.display = "none");
    document.getElementById("input" + e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1)).style.display = "block";
  });

  // 載入下拉選單
  fetch(apiBase).then(res => res.json()).then(data => {
    const select = document.getElementById("routeSelect");
    data.routes.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
  });

  document.getElementById("routeSelect").addEventListener("change", () => {
    const name = document.getElementById("routeSelect").value;
    fetch(apiBase + "?routeName=" + encodeURIComponent(name)).then(res => res.json()).then(data => {
      clearMarkers();
      const list = document.getElementById("stationList");
      list.innerHTML = "";
      data.points.forEach((pt, i) => {
        const id = "chk" + i;
        const row = document.createElement("div");
        row.innerHTML = `<input type="checkbox" id="${id}" data-lat="${pt.lat}" data-lng="${pt.lng}" data-name="${pt.name}" onchange="toggleMarker(this)">
                         [#${pt.order}] ${pt.name || '（未命名）'} (${pt.lat.toFixed(5)}, ${pt.lng.toFixed(5)})`;
        list.appendChild(row);
      });
    });
  });
}

function selectAll(val) {
  document.querySelectorAll("#stationList input[type=checkbox]").forEach(cb => {
    cb.checked = val;
    cb.dispatchEvent(new Event("change"));
  });
}

function toggleMarker(cb) {
  const lat = parseFloat(cb.dataset.lat);
  const lng = parseFloat(cb.dataset.lng);
  const name = cb.dataset.name;
  if (cb.checked) {
    const m = new google.maps.Marker({ position: { lat, lng }, map });
    const info = new google.maps.InfoWindow({ content: name });
    m.addListener("click", () => info.open(map, m));
    cb._marker = m;
  } else if (cb._marker) {
    cb._marker.setMap(null);
  }
}

function clearMarkers() {
  document.querySelectorAll("#stationList input[type=checkbox]").forEach(cb => {
    if (cb._marker) cb._marker.setMap(null);
  });
}

function loadCoords() {
  clearMarkers();
  const lines = document.getElementById("coordsBox").value.trim().split("
");
  lines.forEach((line, i) => {
    const [lat, lng] = line.split(",").map(parseFloat);
    const m = new google.maps.Marker({ position: { lat, lng }, map });
    const info = new google.maps.InfoWindow({ content: "手動點 #" + (i + 1) });
    m.addListener("click", () => info.open(map, m));
  });
}

function findRoute() {
  const dir = new google.maps.DirectionsService();
  const renderer = new google.maps.DirectionsRenderer({ map });
  dir.route({
    origin: document.getElementById("start").value,
    destination: document.getElementById("end").value,
    travelMode: google.maps.TravelMode.BICYCLING
  }, (res, status) => {
    if (status === "OK") renderer.setDirections(res);
    else alert("搜尋失敗：" + status);
  });
}

window.initMap = initMap;
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=places"></script>
</body>
</html>
