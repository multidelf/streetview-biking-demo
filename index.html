<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>一騎出發吧｜街景模擬</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:sans-serif; }
    #map, #pano { width:100vw; height:100vh; }
    #map { display:block; }
    #pano, #miniMap { display:none; }
    #controlPanel { position:absolute; top:60px; left:10px; z-index:10; background:rgba(255,255,255,0.95); padding:12px; width:380px; border-left:5px solid #4CAF50; border-radius:5px; box-shadow:0 2px 8px rgba(0,0,0,0.2); }
    select, textarea, input[type=text], button { width:100%; margin-top:6px; padding:6px; font-size:14px; border:1px solid #ccc; border-radius:4px; }
    .mode-block { display:none; margin-top:10px; }
    .checkbox-row { display:flex; align-items:center; margin-bottom:4px; }
    .checkbox-row input[type=checkbox] { margin-right:8px; }
    #miniMap { position:absolute; bottom:10px; right:10px; width:400px; height:200px; border:2px solid #888; z-index:12; }
  </style>
</head>
<body>
  <div id="controlPanel">
    <!-- Logo and title -->
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <img src="logo.jpg" alt="Logo" style="width:32px; height:32px;">
      <span style="font-size:18px; font-weight:bold;">一騎出發吧｜街景騎乘模擬器V9.2.8</span>
    </div>
    <!-- 操作簡介 -->
    <div style="background:rgba(255,255,255,0.9); padding:8px; border:1px solid #ccc; border-radius:4px; font-size:13px;">
      <strong>操作簡介：</strong><br>
      • 🔽 路線下拉選單：從預設路線中選擇並多選站點<br>
      • 📝 貼上經緯度：自訂座標並繪製站點<br>
      • 📍 A → B 搜尋：輸入地址自動尋找點<br>
         <br>
      • 以上任選一項完成後，點選"切換街景"開始模擬騎乘<br>
          <br>
      • W / ↑：前進一段距離<br>
      • S / ↓：後退一段距離<br>
      • A / D：左右旋轉視角<br>
      • 滑鼠拖曳：旋轉街景視角<br>
      • 街景導航僅可依照規劃路線前進
    </div>
    <!-- 3. 選擇輸入模式 -->
    <label>📌 選擇輸入模式</label>
    <select id="modeSelect">
      <option value="sheet">🔽 路線下拉選單</option>
      <option value="paste">📝 貼上經緯度</option>
      <option value="ab">📍 A → B 搜尋</option>
    </select>
    <!-- 檢視模式區塊 -->
    <div class="mode-block" id="sheetBlock">
      <select id="routeSelect"><option>請選擇路線</option></select>
      <div style="display:flex; gap:10px;">
        <button onclick="selectAll()">全選</button>
        <button onclick="clearAll()">取消全選</button>
      </div>
      <div id="pointList" style="max-height:200px; overflow:auto;"></div>
      <button id="planPolylineBtn">規劃路線</button>
    </div>
    <div class="mode-block" id="pasteBlock">
      <textarea id="coordTextarea" rows="4" placeholder="貼上經緯度，如：24.1612666,120.6951848"></textarea>
      <button onclick="drawFromPasted()">繪製標記</button>
    </div>
    <div class="mode-block" id="abBlock">
      <input id="pointA" placeholder="起點地名或地址">
      <input id="pointB" placeholder="終點地名或地址">
      <button id="searchBtn" onclick="drawFromAB()" disabled>搜尋路線標記</button>
    </div>
    <!-- 4. 切換與自動導航按鈕 -->
    <div style="margin-top:10px;">
      <button id="toggleViewBtn" onclick="toggleView()" style="display:none;">切換街景/地圖</button>
      <button id="autoPlayBtn" onclick="startAutoPlay()" style="display:none; margin-top:6px;">開始自動導航</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="pano"></div>
  <div id="miniMap"></div>

  <!-- 自定義腳本 -->
  <script>
    // 全域變數
    let map, panorama, miniMap, miniMarker, miniPolyline, infoWindow;
    let markers = [], stationData = [], stationMarkersMini = [], polyline, polylinePath = [];
    let currentMode = 'map', stepIndex = 0, autoPlayTimer = null;
    const RESAMPLE_INTERVAL = 20;

    // 1. initMap：初始化地圖、街景及小地圖，並掛載 UI 事件
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), { center:{lat:24.15,lng:120.68}, zoom:13 });
      panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
        position:{lat:24.15,lng:120.68}, pov:{heading:0,pitch:0}, visible:false,
        motionTracking:false, motionTrackingControl:false
      });
      map.setStreetView(panorama);
      miniMap = new google.maps.Map(document.getElementById('miniMap'), { center:{lat:24.15,lng:120.68}, zoom:16, disableDefaultUI:true });
      miniMarker = new google.maps.Marker({ map:miniMap, position:{lat:24.15,lng:120.68}, icon:{ path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale:5, rotation:0 }});
      miniPolyline = new google.maps.Polyline({ map:miniMap, path:[], strokeColor:'#FF5722', strokeWeight:3 });
      infoWindow = new google.maps.InfoWindow();

      setupAutocomplete();
      fetchRouteNames();
      document.getElementById('sheetBlock').style.display='block';
      document.getElementById('modeSelect').addEventListener('change', e => {
        document.querySelectorAll('.mode-block').forEach(b=>b.style.display='none');
        document.getElementById(e.target.value+'Block').style.display='block';
      });
      document.getElementById('planPolylineBtn').addEventListener('click', planPolyline);
      window.addEventListener('keydown', handleKey);
    }
    window.initMap = initMap;

    // 2. setupAutocomplete：設定 A/B 地點自動完成
    function setupAutocomplete() {
      const autoA = new google.maps.places.Autocomplete(document.getElementById('pointA'));
      const autoB = new google.maps.places.Autocomplete(document.getElementById('pointB'));
      autoA.addListener('place_changed', () => {
        const p = autoA.getPlace(); if(!p.geometry) return;
        if(markers.A) markers.A.setMap(null);
        markers.A = new google.maps.Marker({ map, position: p.geometry.location });
        infoWindow.setContent('起點：'+p.name);
        infoWindow.open(map, markers.A);
        map.setCenter(p.geometry.location);
        toggleSearchBtn();
      });
      autoB.addListener('place_changed', () => {
        const p = autoB.getPlace(); if(!p.geometry) return;
        if(markers.B) markers.B.setMap(null);
        markers.B = new google.maps.Marker({ map, position: p.geometry.location });
        infoWindow.setContent('終點：'+p.name);
        infoWindow.open(map, markers.B);
        map.setCenter(p.geometry.location);
        toggleSearchBtn();
      });
    }

    // 3. toggleSearchBtn：啟用/停用搜尋按鈕
    function toggleSearchBtn() {
      const a = document.getElementById('pointA').value.trim();
      const b = document.getElementById('pointB').value.trim();
      document.getElementById('searchBtn').disabled = !(a && b);
    }

    // 4. fetchRouteNames：取得 Google Sheet 路線名單
    async function fetchRouteNames() {
      const res = await fetch('https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec');
      const data = await res.json();
      const sel = document.getElementById('routeSelect');
      sel.innerHTML = '<option>請選擇路線</option>'+data.routes.map(n=>`<option value="${n}">${n}</option>`).join('');
      sel.addEventListener('change', ()=>fetchRouteByName(sel.value));
    }

    // 5. fetchRouteByName：展開站點列表
    async function fetchRouteByName(name) {
      clearMapObjects(); stationData=[]; stationMarkersMini.forEach(m=>m.setMap(null)); stationMarkersMini=[];
      const res = await fetch(`https://script.google.com/macros/s/AKfycbzctNoMZS3m3FX3q1s3Ka4ZgK-bVsMKkOh0rL9IQaS1wO1dprzkUcCpZqE4YpQW7vtA/exec?routeName=${encodeURIComponent(name)}`);
      const d = await res.json();
      const list = document.getElementById('pointList'); list.innerHTML='';
      d.points.forEach((p,i)=>{
        stationData.push({position:{lat:p.lat,lng:p.lng},name:p.name});
        const row = document.createElement('div'); row.className='checkbox-row';
        row.innerHTML=`<input type="checkbox" id="pt${i}"><label for="pt${i}">第${p.order}站 ${p.name}</label>`;
        const cb = row.querySelector('input');
        cb.addEventListener('change', ()=>{
          if(cb.checked){
            const m=new google.maps.Marker({map,position:{lat:p.lat,lng:p.lng}});
            m.addListener('click', ()=>{infoWindow.setContent(p.name);infoWindow.open(map,m);});
            markers[i]=m; map.setCenter(m.getPosition());
          } else if(markers[i]) markers[i].setMap(null);
        });
        list.appendChild(row);
      });
    }

    // 6. planPolyline：規劃路線並更新小地圖站點與路徑
    function planPolyline() {
      stationMarkersMini.forEach(m=>m.setMap(null)); stationMarkersMini=[]; clearMapObjects();
      const boxes = document.querySelectorAll('#pointList input[type=checkbox]');
      const pts = Array.from(boxes).map((cb,i)=>cb.checked?stationData[i].position:null).filter(x=>x);
      if(pts.length<2){alert('請至少選擇兩個站點');return;}
      new google.maps.DirectionsService().route(
        { origin:pts[0], destination:pts.at(-1), waypoints:pts.slice(1,-1).map(l=>({location:l})), travelMode:'BICYCLING' },
        (res,status)=>{
          if(status==='OK'){
            polylinePath = resamplePath(res.routes[0].overview_path,RESAMPLE_INTERVAL);
            drawMainPath(polylinePath);
            miniPolyline.setPath(polylinePath);
            boxes.forEach((cb,i)=>{
              if(cb.checked){
                const s=stationData[i];
                const mm=new google.maps.Marker({map:miniMap,position:s.position,title:s.name,label:{text:s.name,color:'black',fontSize:'10px'}});
                stationMarkersMini.push(mm);
              }
            });
            document.getElementById('toggleViewBtn').style.display='inline-block';
            stepIndex = 0;
            updateMiniMap();
          } else alert('規劃失敗:'+status);
        }
      );
    }

    // 7. clearMapObjects & selectAll/clearAll
    function clearMapObjects(){markers.forEach(m=>m&&m.setMap(null));markers=[];if(polyline)polyline.setMap(null);}
    function selectAll(){document.querySelectorAll('#pointList input[type=checkbox]').forEach(cb=>{cb.checked=true;cb.dispatchEvent(new Event('change'));});}
    function clearAll(){document.querySelectorAll('#pointList input[type=checkbox]').forEach(cb=>{cb.checked=false;cb.dispatchEvent(new Event('change'));});}

    // 8. drawFromPasted & drawFromAB (略)

    // 9. toggleView：切換與顯示/隱藏自動導航按鈕
    function toggleView(){
      const autoBtn = document.getElementById('autoPlayBtn');
      if(currentMode==='map'){
        document.getElementById('map').style.display='none';
        document.getElementById('pano').style.display='block';
        document.getElementById('miniMap').style.display='block';
        panorama.setVisible(true);
        if(polylinePath && polylinePath.length > 0) {
          panorama.setPosition(polylinePath[stepIndex] || polylinePath[0]);
        }
        updateMiniMap();
        currentMode='street';
        autoBtn.style.display='inline-block';  // 進入街景才顯示
      } else {
        document.getElementById('pano').style.display='none';
        document.getElementById('miniMap').style.display='none';
        document.getElementById('map').style.display='block';
        panorama.setVisible(false);
        currentMode='map';
        autoBtn.style.display='none';         // 回地圖才隱藏
        if(autoPlayTimer) { clearInterval(autoPlayTimer); autoPlayTimer=null; autoBtn.textContent='開始自動導航'; }
      }
    }

    // 10. startAutoPlay：自動導航，並同步更新小地圖箭頭
    function startAutoPlay(){
      const btn=document.getElementById('autoPlayBtn');
      if(autoPlayTimer){
        clearInterval(autoPlayTimer); autoPlayTimer=null; btn.textContent='開始自動導航';
      } else {
        btn.textContent='停止自動導航';
        autoPlayTimer = setInterval(()=>{
          if(stepIndex<polylinePath.length-1){ moveAlongPath(1); updateMiniMap(); }
          else{ clearInterval(autoPlayTimer); autoPlayTimer=null; btn.textContent='開始自動導航'; }
        }, 1000);
      }
    }

    // 11. handleKey & moveAlongPath & updateMiniMap

    // 處理鍵盤事件
    function handleKey(e){
      if(currentMode!=='street') return;
      if(e.repeat) return;
      if(e.key==='w' || e.key==='ArrowUp'){ moveAlongPath(1); updateMiniMap(); }
      else if(e.key==='s' || e.key==='ArrowDown'){ moveAlongPath(-1); updateMiniMap(); }
      else if(e.key==='a' || e.key==='ArrowLeft'){ rotatePov(-20); }
      else if(e.key==='d' || e.key==='ArrowRight'){ rotatePov(20); }
    }

    // 沿路徑移動
    function moveAlongPath(dir){
      if(!polylinePath || polylinePath.length===0) return;
      stepIndex += dir;
      if(stepIndex < 0) stepIndex = 0;
      if(stepIndex >= polylinePath.length) stepIndex = polylinePath.length-1;
      panorama.setPosition(polylinePath[stepIndex]);
      updateMiniMap();
    }

    // 旋轉街景視角
    function rotatePov(delta){
      const pov = panorama.getPov();
      pov.heading = (pov.heading + delta + 360) % 360;
      panorama.setPov(pov);
    }

    // 更新小地圖箭頭位置
    function updateMiniMap(){
      if(!polylinePath || polylinePath.length===0) return;
      const pos = polylinePath[stepIndex];
      miniMarker.setPosition(pos);
      // 箭頭方向
      let heading = 0;
      if(stepIndex < polylinePath.length-1){
        heading = google.maps.geometry.spherical.computeHeading(pos, polylinePath[stepIndex+1]);
      } else if(stepIndex > 0){
        heading = google.maps.geometry.spherical.computeHeading(polylinePath[stepIndex-1], pos);
      }
      miniMarker.setIcon({ path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale:5, rotation:heading });
      miniMap.setCenter(pos);
    }

    // 路徑重採樣，讓街景步進更平滑
    function resamplePath(path, interval){
      if(!path || path.length<2) return path;
      let result = [path[0]];
      let dist = 0;
      for(let i=1;i<path.length;i++){
        let segDist = google.maps.geometry.spherical.computeDistanceBetween(path[i-1], path[i]);
        dist += segDist;
        if(dist >= interval){
          result.push(path[i]);
          dist = 0;
        }
      }
      if(result.at(-1)!==path.at(-1)) result.push(path.at(-1));
      return result;
    }

    // 略：drawMainPath, drawFromPasted, drawFromAB（如需可再補）

  </script>

  <!-- Google Maps API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB3MsVlR7h6MsYf1Xjw02BPwB3r95wXsYk&libraries=places,geometry&callback=initMap"></script>
</body>
</html>
